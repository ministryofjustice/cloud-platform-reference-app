version: 2.0
jobs:
  build:
    docker:
      - image: ministryofjustice/cloud-platform-tools
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build application Docker image
          command: |
            docker build -t app .
      - deploy:
          name: Push application Docker image
          command: |
            login="$(AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION} AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID_DEMO} AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY_DEMO} aws ecr get-login --no-include-email)"
            ${login}

            docker tag app "${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPONAME}:${CIRCLE_SHA1}"
            docker push "${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPONAME}:${CIRCLE_SHA1}"

            if [ "${CIRCLE_BRANCH}" == "main" ]; then
              docker tag app "${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPONAME}:latest"
              docker push "${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPONAME}:latest"
            fi
  
  deploy_to_live_1_cluster:
    docker:
      - image: ministryofjustice/cloud-platform-tools
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Authenticate to LIVE-1 cluster
          command: |
            echo -n ${CLUSTER_CERT_LIVE_1} | base64 -d > ./live_1_ca.crt
            kubectl config set-cluster ${CLUSTER_NAME_LIVE_1} --certificate-authority=./live_1_ca.crt --server=https://${API_ENDPOINT_LIVE_1}
            kubectl config set-credentials circleci --token=${TOKEN_LIVE_1}
            kubectl config set-context ${CLUSTER_NAME_LIVE_1} --cluster=${CLUSTER_NAME_LIVE_1} --user=circleci --namespace=${NAMESPACE}
            kubectl config use-context ${CLUSTER_NAME_LIVE_1}
            kubectl config current-context
            kubectl --namespace=${NAMESPACE} get pods
      - deploy:
          name: Apply in LIVE-1 Cluster
          command: |
            if [ "${CIRCLE_BRANCH}" == "main" ]; then
              kubectl -n ${NAMESPACE} apply -f deploy/kubectl/live-1/
              fi
  
  deploy_to_live_cluster:
    docker:
      - image: ministryofjustice/cloud-platform-tools
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Authenticate to LIVE cluster
          command: |
            echo -n ${CLUSTER_CERT_LIVE} | base64 -d > ./live_ca.crt
            kubectl config set-cluster ${CLUSTER_NAME_LIVE} --certificate-authority=./live_ca.crt --server=https://${API_ENDPOINT_LIVE}
            kubectl config set-credentials circleci --token=${TOKEN_LIVE}
            kubectl config set-context ${CLUSTER_NAME_LIVE} --cluster=${CLUSTER_NAME_LIVE} --user=circleci --namespace=${NAMESPACE}
            kubectl config use-context ${CLUSTER_NAME_LIVE}
            kubectl config current-context
            kubectl --namespace=${NAMESPACE} get pods
      - deploy:
          name: Apply in LIVE CLUSTER
          command: |
            if [ "${CIRCLE_BRANCH}" == "main" ]; then
              kubectl -n ${NAMESPACE} apply -f deploy/kubectl/live/
            fi


workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy_to_live_1_cluster:
          requires:
            - build
      - deploy_to_live_cluster:
          requires:
            - build
